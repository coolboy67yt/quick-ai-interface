<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TrtlChat</title>
    <style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: #1e1e2f;
  color: #fff;
  margin: 0;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

/* Header */
.navbar {
  background-color: #20232a;
  color: #ffffff;
  padding: 10px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 2px solid #444;
}

.title-container {
  display: flex;
  align-items: center;
}

.title-container span {
  font-size: 2em; /* Adjust size of the emoji */
  margin-right: 10px; /* Add spacing between the emoji and the text */
}

.main-title {
  margin: 0;
  font-size: 1.5em; /* Adjust title font size */
}

.subtitle {
  margin: 0;
  font-size: 0.9em; /* Adjust subtitle font size */
  color: gray; /* Optional: Change subtitle text color */
}

.nav-buttons button {
  background-color: #444;
  color: #fff;
  border: none;
  padding: 6px 12px;
  margin-left: 10px;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.nav-buttons button:hover {
  background-color: #666;
}

/* Layout */
.main-container {
  display: flex;
  flex: 1;
  height: 100%;
  overflow: hidden;
}

/* Sidebar */
.sidebar {
  width: 250px;
  background-color: #2b2b3c;
  color: white;
  padding: 20px;
  transition: width 0.3s ease;
  position: relative;
  display: flex;
  flex-direction: column;
}

.sidebar.collapsed div.text{
  display: none;
}

.sidebar.collapsed {
  width: 60px;
  padding: 10px 0;
}

.sidebar .toggle-btn {
  background-color: #2b2b3c;
  border: none;
  border-radius: 50%;
  color: white;
  font-size: 24px;
  width: 50px;
  height: 50px;
  cursor: pointer;
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  transition: right 0.3s ease, left 0.3s ease, font-size 0.3s ease, width 0.3s ease, height 0.3s ease;
}

.sidebar.collapsed .toggle-btn {
  font-size: 30px;
  width: 50px;
  height: 50px;
  left: 50%;
  transform: translateY(-50%) translateX(-50%);
}

.sidebar:not(.collapsed) .toggle-btn {
  font-size: 18px;
  width: 40px;
  height: 40px;
  right: -20px;
  transform: translateY(-50%);
}

.sidebar h2 {
  font-size: 1.2rem;
  margin-top: 0;
}

.sidebar ul {
  list-style: none;
  padding: 0;
}

.sidebar li {
  margin: 0.5rem 0;
}

.sidebar a {
  color: #ccc;
  text-decoration: none;
  transition: color 0.2s;
}

.sidebar a:hover {
  color: white;
}

.chat-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Chat Area */
#chat {
  flex: 1;
  padding: 1rem;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.message {
  max-width: 70%;
  padding: 0.75rem 1rem;
  border-radius: 1rem;
  line-height: 1.4;
  white-space: pre-wrap;
}

.user {
  background: #4a90e2;
  align-self: flex-end;
}

.assistant {
  background: #2a2a3d;
  align-self: flex-start;
}

.assistant .content {
  animation: fadeIn 0.3s ease-in;
}

.assistant .content p {
  margin: 0;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to   { opacity: 1; }
}

/* Input Area */
#input-area {
  display: flex;
  padding: 1rem;
  background: #15151f;
  border-top: 1px solid #333;
}

#input {
  flex: 1;
  padding: 0.75rem;
  border: none;
  border-radius: 0.5rem;
  font-size: 1rem;
}

#send {
  margin-left: 1rem;
  background: #4a90e2;
  color: white;
  border: none;
  border-radius: 0.5rem;
  padding: 0 1rem;
  cursor: pointer;
  font-size: 1rem;
}

#send:hover {
  background: #3a7ac9;
}

/* Loading */
.loading::after {
  content: "‚è≥";
  animation: blink 1s infinite;
  margin-left: 0.5rem;
}

@keyframes blink {
  0%, 100% { opacity: 0.2; }
  50% { opacity: 1; }
}

.text ul li {
  position: relative;
  padding: 5px 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chat-icons {
  display: none; /* Hidden by default */
}

.text ul li:hover .chat-icons {
  display: inline-flex; /* Show icons on hover */
  gap: 5px;
}

.chat-icons i {
  font-size: 0.9em;
  cursor: pointer;
  color: gray;
  transition: color 0.3s ease;
}

.chat-icons i:hover {
  color: white;
}
.chat-icons i.fa-trash:hover {
  color: #e52a58;
}

button.newchat {
  background: #3F5EFB;
  background: linear-gradient(109deg,rgba(63, 94, 251, 1) 0%, rgba(252, 70, 107, 1) 100%);
  color: white;
  border-radius: 10px;
  box-shadow: none;
  text-decoration: none;
  display: inline-block;
  border: 1px solid white;
  padding: 5px;
  padding-left: 10px;
  padding-right: 10px;
  cursor: pointer;
}

.button-container{
display: flex;
justify-content: right;
}

/* Style for the modal */
.modal {
  display: none; /* Hidden by default */
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5); /* Black with opacity */
}

/* Modal content */
.modal-content {
  background-color: #000;
  margin: 0 auto;  /* Center horizontally */
  padding: 20px;
  border: 1px solid #888;
  width: 80%;
  max-width: 500px;
  border-radius: 8px;
  /* Vertically center the modal */
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

/* Close button */
.close-btn {
  color: #aaa;
  font-size: 30px;
  font-weight: bold;
  float: right;
  cursor: pointer;
}

.close-btn:hover,
.close-btn:focus {
  color: white;
  text-decoration: none;
  cursor: pointer;
}
.save-settings {
  background-color: lime;
  color: white;
  border: none;
  border-radius: 5px;
  padding: 3px;
  padding-left: 6px;
  padding-right: 6px;
}

.chat-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.title {
  display: flex;
  justify-content: flex-start;
  flex: 1;
}

.button-container {
  display: flex;
  justify-content: flex-end;
}

textarea {
  max-height: 200px;
  overflow-y: auto;
}

div.dev {
  text-align: center;
  padding: 2px;
  font-family: Consolas;
  background-color: #1a1d23;
}      
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://kit.fontawesome.com/2ff1179492.js" crossorigin="anonymous"></script>
    <link rel="icon" type="image/png" href="https://emojik.vercel.app/s/%F0%9F%90%A2_%F0%9F%A4%96?size=128" sizes="16x16" />
  </head>
  <body>
    <div class="dev">DEVELOPER PREVIEW</div>
    <header class="navbar">
      <div class="title-container">
        <span style="font-size: 2em; margin-right: 10px;">üê¢</span>
        <div>
          <h1 class="main-title">TrtlChat</h1>
          <p class="subtitle">powered by teatree.chat</p>
        </div>
      </div>
      <nav class="nav-buttons">
        <button onclick="openAbout()">
          <i class="fas fa-info-circle"></i> About
        </button>
        <button onclick="openSettings()">
          <i class="fas fa-cog"></i> Settings
        </button>
      </nav>
    </header>

    <div class="main-container">
      <aside class="sidebar" id="sidebar">
        <button class="toggle-btn" id="toggleBtn">
          <i class="fas fa-chevron-left"></i>
        </button>
        <div class="text">
          
      </aside>
      <div class="chat-area">
        <div id="chat"></div>

        <div id="input-area">
          <textarea id="input" placeholder="Say something..." rows="1" style="resize: none;"></textarea>
          <button id="send"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
  const chat = document.getElementById('chat');
  const input = document.getElementById('input');
  const send = document.getElementById('send');
  const sidebar = document.getElementById('sidebar');
  const API_URL = '/api/proxy';

  let chats = getChatsFromCookies();
  let currentChatId = chats.length > 0 ? chats[0].id : null;

  if (currentChatId === null) {
    currentChatId = createNewChat(false); // Create new chat if no chats exist
  }

  renderSidebar();
  loadChat(currentChatId);

  if (!chat || !input || !send || !sidebar) {
    console.error('üö® üö® üö® WOAOAOAOAOOO! SOMETHING IS SERIOUSLY WRONG! LIKE, SUPER SUPER SUPER WRONG! LIKE TERRIBLY WRONG! LIKE THE WORLD IS ENDING WRONG!! AAAAAAAAAAAA!! PANIC!!!!!!!!!!!!!!! üö® üö® üö®');
    return;
  }
function appendMessage(content, sender, isLoading = false) {
  const div = document.createElement('div');
  div.classList.add('message', sender);

  const contentDiv = document.createElement('div');
  contentDiv.className = 'content';
  if (sender === 'assistant') {
    contentDiv.innerHTML = marked.parse(content);
  } else {
    contentDiv.textContent = content;
  }

  div.appendChild(contentDiv);
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;

  if (isLoading) {
    div.classList.add('loading');
    div.setAttribute('id', 'loading-message');
  }
}

function updateassistantMessageTyped(msg) {
  const div = document.getElementById('loading-message');
  if (!div) return;

  div.classList.remove('loading');
  div.removeAttribute('id');

  const contentDiv = div.querySelector('.content');
  contentDiv.innerHTML = "";

  let i = 0;
  const fullHTML = marked.parse(msg);
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = fullHTML;
  const text = tempDiv.textContent || tempDiv.innerText || "";

  const typing = setInterval(() => {
    if (i >= text.length) {
      clearInterval(typing);
      contentDiv.innerHTML = fullHTML;
      return;
    }
    contentDiv.textContent += text[i++];
    chat.scrollTop = chat.scrollHeight;
  }, 15);
}

function getChatsFromCookies() {
  const cookie = document.cookie.split('; ').find(row => row.startsWith('chats='));
  if (!cookie) return [];
  try {
    return JSON.parse(decodeURIComponent(cookie.split('=')[1]));
  } catch (e) {
    return [];
  }
}

function saveChatsToCookies() {
  const expDate = new Date();
  expDate.setFullYear(expDate.getFullYear() + 20); // Sure, 20 years isn't exactly "forever", but let's be honest. Who TF will use this 20 years from now?
  document.cookie = `chats=${encodeURIComponent(JSON.stringify(chats))}; path=/; expires=${expDate.toUTCString()}`;
}

function createNewChat(saveImmediately = true) {
  const newChat = { id: Date.now(), name: `New Chat`, messages: [] };
  chats.push(newChat);
  if (saveImmediately) saveChatsToCookies();
  renderSidebar();
  loadChat(newChat.id); // Load the new chat immediately
  return newChat.id;
}


function deleteChat(chatId) {
  if (confirm("Are you sure you want to delete this chat?")) {
    chats = chats.filter(chat => chat.id !== chatId);
    saveChatsToCookies();
    renderSidebar();
    if (chats.length > 0) {
      loadChat(chats[0].id);
    } else {
      currentChatId = createNewChat(false);
      loadChat(currentChatId);
    }
  }
}

function loadChat(chatId) {
  currentChatId = chatId;
  const currentChat = chats.find(chat => chat.id === chatId);
  chat.innerHTML = '';
  currentChat.messages.forEach(msg => appendMessage(msg.content, msg.role));
}

function sendMessage() {
  input.style.height = 'auto';
  input.style.overflow = 'auto';
  const userInput = input.value.trim();
  if (!userInput) return;

  const currentChat = chats.find(chat => chat.id === currentChatId);

  // Update chat name if it's the first msg
  if (currentChat.messages.length === 0) {
    currentChat.name = userInput.length > 20 ? `${userInput.substring(0, 20)}...` : userInput;
    saveChatsToCookies();
    renderSidebar();
  }

  appendMessage(userInput, 'user');
  currentChat.messages.push({ role: 'user', content: userInput });
  input.value = '';

  appendMessage('', 'assistant', true);

  fetch(API_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      model: 'gpt-4o',
      messages: currentChat.messages,
      max_tokens: 500,
      temperature: 0.7
    })
  })
  .then(res => res.json())
  .then(data => {
    // Check if we received the expected data structure
    if (data.choices && data.choices.length > 0 && data.choices[0].message) {
      const assistantReply = data.choices[0].message.content;
      updateassistantMessageTyped(assistantReply);
      currentChat.messages.push({ role: 'assistant', content: assistantReply });
      saveChatsToCookies();
    } else {
      updateassistantMessageTyped('‚ö† Something went wrong. Please try again later.\nIf the problem persists, open an issue on the Github.');
    }
  })
  .catch((error) => {
    // Log and show error message if fetch fails
    console.error('Error details:', error); // Log error details for debugging
    if (!error.code) {
      updateassistantMessageTyped(`‚ö† Something went wrong. Please try again later.\nIf the problem persists, open an issue on the Github.`);      
    } else {
      updateassistantMessageTyped(`‚ö† Error code ${error?.code}`);
    }
  });
}

function renderSidebar() {
  const textDiv = sidebar.querySelector('.text');
  textDiv.innerHTML = `
  <div class="chat-bar">
    <div class="title">
      <h2>Your Chats</h2>
    </div>
    <div class="button-container">
      <button class="newchat" onclick="createNewChat()"><b>+</b></button></div>
    </div>
  </div>
    <ul>
      ${chats.map(chat => `
        <li>
          <a href="#" onclick="loadChat(${chat.id})">${chat.name}</a>
          <span class="chat-icons">
            <i class="fas fa-trash" onclick="deleteChat(${chat.id})"></i>
          </span>
        </li>
      `).join('')}
    </ul>
  `;
}

send.addEventListener('click', sendMessage);
input.addEventListener('keydown', (event) => {
  if (event.key === 'Enter') {
    if (event.shiftKey) {
      // Allow newline
      return;
    } else {
      event.preventDefault(); // Prevent newline
      sendMessage();
    }
  }
});
  
input.addEventListener('input', () => {
  // Reset height to calculate correctly
  input.style.height = 'auto';

  // Limit expansion to 200px (you can change this)
  const maxHeight = 200;
  input.style.overflowY = input.scrollHeight > maxHeight ? 'scroll' : 'hidden';
  input.style.height = `${Math.min(input.scrollHeight, maxHeight) - 1}px`;
});


// do stuff
window.loadChat = loadChat;
window.deleteChat = deleteChat;
window.createNewChat = createNewChat;

});

const sidebar = document.getElementById('sidebar');
const toggleBtn = document.getElementById('toggleBtn');

toggleBtn.addEventListener('click', () => {
  sidebar.classList.toggle('collapsed');
  const icon = sidebar.classList.contains('collapsed') ? 'fa-chevron-right' : 'fa-chevron-left';
  toggleBtn.innerHTML = `<i class="fas ${icon}"></i>`;
});

function openAbout() {
  window.location.href = 'about.html';
}

// Function to open the settings modal
function openSettings() {
  const settingsModal = document.getElementById('settingsModal');
  settingsModal.style.display = 'block';
}

// Function to close the settings modal
function closeSettings() {
  const settingsModal = document.getElementById('settingsModal');
  settingsModal.style.display = 'none';
}

// Close the modal if the user clicks outside of the modal content
window.onclick = function(event) {
  const settingsModal = document.getElementById('settingsModal');
  if (event.target === settingsModal) {
    settingsModal.style.display = 'none';
  }
}
    </script>
     <div id="settingsModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeSettings()">&times;</span>
      <h2>Settings üîß</h2>
      <p>These are just placeholders and do not save or do anything</p>
      <hr>
      <form>
        <label for="setting1"><b>System Prompt</b></label>
        <br>
        <textarea id="setting1" rows="4" cols="50" style="resize: none;">default prmpt</textarea><br><br>

        <label for="setting2">Developer Mode</label>
        <input type="checkbox" id="setting2"><br><br>

        <button class="save-settings" type="submit">Save</button>
      </form>
    </div>
  </div>
  </body>
</html>
